<!DOCTYPE html>
<html>
  <head>
    <title>Instascan</title>
    <link rel="stylesheet" href="https://schmich.github.io/instascan/style.css">
    	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  </head>
  <body>
    <video id="preview"></video>
    <script type="text/javascript">
      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      scanner.addListener('scan', function (content) {
        var result = content;
	var requestURL = "https://drugpug.azure-api.net/bff/verify";

	var myHeaders = new Headers();
	myHeaders.append("Content-Type", "application/json");
        var queryObject = {};
        queryObject.signedContent = result;
        
        console.log("result is " + result);

	console.log(JSON.stringify(queryObject));
        // send to the endpoint
        fetch(requestURL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: myHeaders,
		body: JSON.stringify(queryObject)
            }).then(function(response) {
                if (response.status == 200) {
                     response.json()
                     .then(data => {
                         var productName = data["_source"]["name"];
                         console.log(productName);
                         location.href = "http://40.127.146.90/?" + productName;
                     }); 
                } else {
                    alert("This QR Code is not signed by the authority.");
                }

                console.log(response);
            })
            .catch(error => {
                console.error('Error:', error);
            }); 
      });
      Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
          scanner.start(cameras[0]);
        } else {
          console.error('No cameras found.');
        }
      }).catch(function (e) {
        console.error(e);
      });
    </script>
  </body>
</html>
